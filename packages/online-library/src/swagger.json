{
  "openapi": "3.0.0",
  "info": {
    "version": "1.0.0",
    "title": "Online Library",
    "description": "API for Online Library"
  },
  "servers": [
    {
      "url": "http://localhost:3001/"
    }
  ],
  "paths": {
    "/api/user/auth/register": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Checks if user already exist <br />  ✅ Generates an <b>activation token</b> <br />  ✅ Sends link with the <b>token</b> to allow user activate his account <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Activate account by clicking the link that has been sent to you"
          },
          "409": {
            "description": "Email address already taken"
          },
          "422": {
            "description": "Data validation failed"
          },
          "502": {
            "description": "There was a problem sending the activation link"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/register"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/register"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/activateAccount": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Check if user already activated his account <br />  ✅ Toggles account as activated if it's not alread <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Account activated, you can login now"
          },
          "403": {
            "description": "Account already activated"
          },
          "409": {
            "description": "No authentication associated with this link"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/activateAccount"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/activateAccount"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/resendActivationToken": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Ensures user with provided email address exists <br />  ✅ Rejects resending activation token if account is already activate <br />  ✅ Sends new activation token to the use <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Link with new activation token has been sent"
          },
          "403": {
            "description": "Account already activated"
          },
          "404": {
            "description": "Provided email address is invalid"
          },
          "422": {
            "description": "Data validation failed"
          },
          "502": {
            "description": "There was a problem sending the activation link"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/resendActivationToken"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/resendActivationToken"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/login": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Checks given email and password <br />  ✅ Check if account is activated <br />  ✅ Sends auth token, that expires in 24h, if credentials are ok<br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Auth token was set in cookies"
          },
          "401": {
            "description": "The given credentials are wrong"
          },
          "403": {
            "description": "Account not activated"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/login"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/login"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/loginWithFacebook": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Verifies <b>access token</b> provided by FB auth <br />  ✅ Sends <b>auth token</b>, that expires in 24h, for either already existing user or newly created one <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Auth token was set in cookies"
          },
          "400": {
            "description": "There was an unexpected problem with FB authentication"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/loginWithFacebook"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/loginWithFacebook"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/recoverPassword": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Checks if any user belongs to provided email address <br />  ✅ Makes sure that user account is activated <br />  ✅ Generates <b>password token</b> to authorize changing password in the next step (password form) <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Link to reset the password has been sent"
          },
          "404": {
            "description": "An incorrect email address was provided"
          },
          "409": {
            "description": "Account must be firstly activated"
          },
          "422": {
            "description": "Data validation failed"
          },
          "502": {
            "description": "There was a problem sending the link allowing resetting password"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/recoverPassword"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/recoverPassword"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/checkPasswordToken": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Checks password token generated by <b>/api/user/auth/recoverPassword</b> <br />  ✅ Checks if there is a user with email address as kept in password token <br />  ",
        "parameters": [],
        "responses": {
          "400": {
            "description": "Link to reset the password is invalid"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/checkPasswordToken"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/checkPasswordToken"
              }
            }
          }
        }
      }
    },
    "/api/user/auth/changePassword": {
      "post": {
        "tags": [
          "Auth (rate limited)"
        ],
        "description": "  ✅ Changes user password <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Password has been changed"
          },
          "400": {
            "description": "Link to reset the password is invalid"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/changePassword"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/changePassword"
              }
            }
          }
        }
      }
    },
    "/api/user/books/getSuggestions": {
      "post": {
        "tags": [
          "Books"
        ],
        "description": "  ✅ Suggest books by author or title <br />  ✅ Searches either books assigned to the user or from the whole store <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Returns array of books that meet certain title or author",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/book"
                  },
                  "xml": {
                    "name": "main"
                  }
                }
              },
              "application/xml": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/book"
                  },
                  "xml": {
                    "name": "main"
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "token": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/getSuggestions"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/getSuggestions"
              }
            }
          }
        }
      }
    },
    "/api/user/cart/purchaseBooksWithStripe": {
      "post": {
        "tags": [
          "Cart"
        ],
        "description": "  ✅ Makes sure that user does not pay for already purchased books <br />  ✅ Checks if selected books are still available in the store <br />  ✅ Processes stripe payment with credit card <br />  ✅ Assigns purchased books to the user <br />  ",
        "parameters": [],
        "responses": {
          "402": {
            "description": "Payment has failed"
          },
          "404": {
            "description": "Selected books are not available anymore"
          },
          "409": {
            "description": "You have already purchased selected books before"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/purchaseBooksWithStripe"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/purchaseBooksWithStripe"
              }
            }
          }
        }
      }
    },
    "/api/user/cart/createPayPalPayment": {
      "post": {
        "tags": [
          "Cart"
        ],
        "description": "  ✅ Makes sure that user does not pay for already purchased books <br />  ✅ Checks if selected books are still available in the store <br />  ✅ Prepares paypal payment details <br />  ✅ Redirects user to paypal checkout <br />  ",
        "parameters": [],
        "responses": {
          "200": {
            "description": "Returns paypal checkout link",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/paypalApprovalLink"
                }
              },
              "application/xml": {
                "schema": {
                  "$ref": "#/components/schemas/paypalApprovalLink"
                }
              }
            }
          },
          "402": {
            "description": "There was a problem preparing the payment, try again"
          },
          "404": {
            "description": "Selected books are not available anymore"
          },
          "409": {
            "description": "You have already purchased selected books before"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/createPayPalPayment"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/createPayPalPayment"
              }
            }
          }
        }
      }
    },
    "/api/user/cart/executePayPalPayment": {
      "post": {
        "tags": [
          "Cart"
        ],
        "description": "  ✅ Checks if user booked paymeny with certain id <br />  ✅ Checks if payment is still in progress <br />  ✅ Finalizes paypal payment and updates its status <br />  ✅ Assigns purchased books to the user <br />  ",
        "parameters": [],
        "responses": {
          "402": {
            "description": "Payment has failed"
          },
          "404": {
            "description": "Bad payment id"
          },
          "409": {
            "description": "The order has been already approved"
          },
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/executePayPalPayment"
              }
            },
            "application/xml": {
              "schema": {
                "$ref": "#/components/schemas/executePayPalPayment"
              }
            }
          }
        }
      }
    },
    "/api/user/chat/getMessages": {
      "post": {
        "tags": [
          "Chat"
        ],
        "description": "",
        "parameters": [],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ]
      }
    },
    "/api/user/chat/sendMessage": {
      "post": {
        "tags": [
          "Chat"
        ],
        "description": "",
        "parameters": [],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ]
      }
    },
    "/api/user/chat/sendFile": {
      "post": {
        "tags": [
          "Chat"
        ],
        "description": "",
        "parameters": [],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ]
      }
    },
    "/api/user/chat/subscribePushNotifications": {
      "post": {
        "tags": [
          "Chat"
        ],
        "description": "",
        "parameters": [],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ]
      }
    },
    "/api/user/chat/getMessagesInfo": {
      "get": {
        "tags": [
          "Chat"
        ],
        "description": "",
        "parameters": [],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        },
        "security": [
          {
            "token": []
          }
        ]
      }
    },
    "/api/user/global/checkToken": {
      "get": {
        "tags": [
          "Global"
        ],
        "description": "  ✅ Checks existance of <b>auth token</b> in cookies and validates it <br />  ✅ Returns proper role to the end user <br />  ",
        "parameters": [
          {
            "name": "token",
            "in": "cookies",
            "description": "Auth token",
            "required": false,
            "schema": {
              "$ref": "#/components/schemas/jwt"
            }
          }
        ],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        }
      }
    },
    "/api/user/global/logout": {
      "get": {
        "tags": [
          "Global"
        ],
        "description": "  ✅ Logs user out <br />  ✅ Removes auth token from cookies <br />  ",
        "parameters": [
          {
            "name": "token",
            "in": "cookies",
            "description": "Auth token",
            "required": false,
            "schema": {
              "$ref": "#/components/schemas/jwt"
            }
          }
        ],
        "responses": {
          "422": {
            "description": "Data validation failed"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "book": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 13
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "example": "2022-08-28T19:41:46.422Z"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time",
            "example": "2022-08-28T19:41:46.422Z"
          },
          "title": {
            "type": "string",
            "example": "Hound Dog"
          },
          "author": {
            "type": "string",
            "example": "Nina Barton"
          },
          "cover": {
            "type": "string",
            "format": "uri",
            "qt-uri-protocols": [
              "https"
            ],
            "example": "https://loremflickr.com/640/480/nature?78445"
          },
          "price": {
            "anyOf": [
              {
                "type": "integer"
              },
              {
                "type": "null"
              }
            ],
            "description": "Price in $",
            "example": 14
          }
        }
      },
      "paypalApprovalLink": {
        "type": "string",
        "required": true,
        "description": "Link to paypal checkout generated with /createPayPalPayment",
        "example": "https://www.sandbox.paypal.com/cgi-bin/webscr?cmd=_express-checkout&token=EC-27H754218P7505C"
      },
      "plain": {
        "type": "string",
        "example": "plain text",
        "xml": {
          "name": "plain"
        }
      },
      "paypalPaymentId": {
        "type": "string",
        "example": "",
        "xml": {
          "name": "paypalPaymentId"
        }
      },
      "paypalPayerID": {
        "type": "string",
        "example": "",
        "xml": {
          "name": "paypalPayerID"
        }
      },
      "register": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "required": true,
            "example": "John"
          },
          "email": {
            "type": "string",
            "format": "email",
            "required": true,
            "example": "john@onlinelibrary.com"
          },
          "password": {
            "type": "string",
            "required": true,
            "example": "2hIq8^spf2"
          },
          "repeatedPassword": {
            "type": "string",
            "required": true,
            "example": "2hIq8^spf2"
          }
        }
      },
      "activateAccount": {
        "type": "object",
        "properties": {
          "activationToken": {
            "type": "string",
            "required": true,
            "description": "jwt token",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
          }
        }
      },
      "resendActivationToken": {
        "type": "object",
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "required": true,
            "example": "john@onlinelibrary.com"
          }
        }
      },
      "login": {
        "type": "object",
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "required": true,
            "example": "john@onlinelibrary.com"
          },
          "password": {
            "type": "string",
            "required": true,
            "example": "2hIq8^spf2"
          }
        }
      },
      "loginWithFacebook": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "required": true,
            "example": "John"
          },
          "email": {
            "type": "string",
            "format": "email",
            "required": true,
            "example": "john@onlinelibrary.com"
          },
          "access_token": {
            "type": "string",
            "required": true,
            "description": "Access token generated with FB auth",
            "example": "EAAG6VehVAPMBAK30w7QenD65zUARr9d4P3yQf44X5anasd6QnjtEtXH2c7TG234fsBMchb4Pe"
          }
        }
      },
      "recoverPassword": {
        "type": "object",
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "required": true,
            "example": "john@onlinelibrary.com"
          }
        }
      },
      "checkPasswordToken": {
        "type": "object",
        "properties": {
          "passwordToken": {
            "type": "string",
            "required": true,
            "description": "jwt token",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
          }
        }
      },
      "changePassword": {
        "type": "object",
        "properties": {
          "password": {
            "type": "string",
            "required": true,
            "example": "2hIq8^spf2"
          },
          "passwordToken": {
            "type": "string",
            "required": true,
            "description": "jwt token",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
          }
        }
      },
      "purchaseBooksWithStripe": {
        "type": "object",
        "properties": {
          "paymentId": {
            "type": "string",
            "required": true,
            "description": "Payment method id, created with stripejs package on the client side",
            "example": "pm_1LeJuTCA0Hw88eOYpY9kEDWK"
          },
          "products": {
            "type": "array",
            "items": {
              "type": "integer"
            },
            "required": true,
            "description": "Array of book ids to purchase",
            "example": [
              1,
              5,
              9,
              11
            ]
          }
        }
      },
      "createPayPalPayment": {
        "type": "object",
        "properties": {
          "products": {
            "type": "array",
            "items": {
              "type": "integer"
            },
            "required": true,
            "description": "Array of book ids to purchase",
            "example": [
              1,
              5,
              9,
              11
            ]
          }
        }
      },
      "executePayPalPayment": {
        "type": "object",
        "properties": {
          "paymentId": {
            "type": "string",
            "required": true,
            "description": "Payment id generated after submitting paypal checkout",
            "example": "PAYID-MMKLWRQ82689537V0194325L"
          },
          "PayerID": {
            "type": "string",
            "required": true,
            "description": "Payer id generated after submitting paypal checkout",
            "example": "KVYVDZAMZGRRA"
          }
        }
      },
      "getSuggestions": {
        "type": "object",
        "properties": {
          "title": {
            "type": "string",
            "required": true,
            "description": "Title to search for. It takes precedence over the author",
            "example": "Let it Be"
          },
          "author": {
            "type": "string",
            "required": true,
            "description": "Author to search for",
            "example": "Craig Nicolas"
          },
          "withProfile": {
            "type": "boolean",
            "required": true,
            "description": "If true, it searches books assigned to the user. Otherwise searches in the whole store"
          }
        }
      }
    },
    "securitySchemes": {
      "token": {
        "in": "cookie",
        "name": "token",
        "type": "apiKey",
        "description": "Auth token (jwt) generated with /login or /loginWithFacebook"
      }
    }
  }
}